name: Deploy NestJS Docker to ECR

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: staging
        type: choice
        options:
          - staging
          - preprod
          - prod
  push:
    branches:
      - staging
      - preprod
      - prod

env:
  AWS_REGION: eu-north-1

permissions:
  id-token: write # nécessaire pour OIDC
  contents: read # pour checkout

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Debug OIDC token (temporaire, peut être retiré après test)
      - name: Debug OIDC token
        run: |
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=$ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN=$ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          curl -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL" || echo "Token fetch failed"

      # 3️⃣ Configure AWS via OIDC
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::585665041354:role/GitHubActionsTerraformRole
          aws-region: eu-north-1
          role-session-name: github-actions-nest
          # audience supprimé, géré automatiquement

      # 4️⃣ Determine environment
      - name: Set environment
        run: |
          if [ -n "${{ github.event.inputs.environment }}" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=${GITHUB_REF##*/}" >> $GITHUB_ENV

      # 5️⃣ Get ECR URI from SSM
      - name: Get ECR URI from SSM
        id: get_ecr_uri
        run: |
          ECR_URI=$(aws ssm get-parameter \
            --name "/ecr/${ENVIRONMENT}/uri" \
            --query "Parameter.Value" \
            --output text)
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV
          echo "ECR_URI=$ECR_URI"

      # 6️⃣ Login to ECR
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin $ECR_URI

      # 7️⃣ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t $ECR_URI:${GITHUB_SHA} .

      # 8️⃣ Push Docker image to ECR
      - name: Push Docker image
        run: |
          docker push $ECR_URI:${GITHUB_SHA}

      # 9️⃣ Optional: Tag latest
      - name: Tag latest
        if: github.event.inputs.environment == 'staging'
        run: |
          docker tag $ECR_URI:${GITHUB_SHA} $ECR_URI:latest
          docker push $ECR_URI:latest
